$ ->
  $('body').on 'keyup ', ".quantity-field, .price-field", (e) ->
    e.preventDefault()
    console.log('hi')
    if $(this).hasClass('quantity-field') == true
      quantity = parseFloat($(this).val())
      price = parseFloat($(this).parent().next().children().first().val())
      total = (quantity * price).toFixed(2)
      console.log(total)
      if isNaN(total) == false
        input = $(this).parent().next().next().children().first()
        $(input).empty().val(total).prop('disabled', true)
        sumTotal = 0
        $(".total-field").each (index, element) =>
          sumTotal += parseFloat($(element).val())
          console.log(sumTotal)
        $("#sum").empty().append("<h3>Total : $#{sumTotal.toFixed(2)}</h3>")
    else
      price = parseFloat($(this).val())
      quantity = parseFloat($(this).parent().prev().children().first().val())
      total = (quantity * price).toFixed(2)
      console.log(total)
      if isNaN(total) == false
        input = $(this).parent().next().children().first()
        $(input).empty().val(total).prop('disabled', true)
        sumTotal = 0
        $(".total-field").each (index, element) =>
          sumTotal += parseFloat($(element).val())
          console.log(sumTotal)
        $("#sum").empty().append("<h3>Total : $#{sumTotal.toFixed(2)}</h3>")
    console.log(quantity + " " + price)

  $('.due-date-field').datepicker()

  $('.add-line-item').click (e) ->
    e.preventDefault()
    index = $('.line-item-row').size()
    lineItemRow = $('.line-item-row').first().clone()
    console.log($(lineItemRow).parent())
    $(lineItemRow).find('.note-field').attr('name', "invoice[line_items_attributes][#{index}][note]")
    $(lineItemRow).find('.note-field').val("")
    $(lineItemRow).find('.quantity-field').attr('name', "invoice[line_items_attributes][#{index}][quantity]").val("")
    $(lineItemRow).find('.price-field').attr('name', "invoice[line_items_attributes][#{index}][price]").val("")
    $(lineItemRow).find("#total").val("")
    console.log($(lineItemRow))
    $("#line-items-table tbody").append($(lineItemRow))


  $('body').on 'click',  '.remove-line-item', (e) ->
    e.preventDefault()
    if $('.line-item-row').size() > 1
      console.log('remove')
      total = parseFloat($("#sum h3").text().replace( /^\D+/g, ''))
      itemVal = parseFloat($(this).parent().prev().children().val())
      console.log(total - itemVal)
      $(this).parent().parent().remove()
      $("#sum h3").empty().append("<h3>Total : $#{total-itemVal}</h3>")


  $('.show-mailer-button').click (e) ->
    e.preventDefault()
    $(this).text('Sent').removeClass('btn btn-default').addClass('sent-show-mailer')
    path = $(this).attr('href')
    $.get path, (data) ->
      console.log(data)

  $('.make-invoice').click (e) ->
    e.preventDefault()
    console.log("made invoice")
    $(this).removeClass('btn btn-default').addClass('sent-show-mailer')
    id = $(this).data('id')
    path = $(this).attr('href')
    console.log(id)
    $.post path, data:{'estimate-id': id}, (data) ->
      console.log(data)

  $('.due-date-sort , .contact-sort, .total-sort, .status-sort').click (e) ->
    e.preventDefault()
    console.log('hit')
    dataType = $(this).data('type')
    ids = []
    $.map $(".line-item-show-row"), (n) ->
      ids.push($(n).data "id")
    console.log(ids)
    $(this).toggleClass('forward')
    forward = $(this).hasClass('forward')
    console.log(dataType)
    category = $(this).data('category')
    path = '/invoices/sort'
    $.post path, data:{'type':dataType, 'category':category, 'forward': forward, 'ids': ids}, (data) ->
      $(".line-item-show-row").empty().remove()
      $("#invoices-index-table tbody").append($(data))

  $('body').on 'click', '.back-all', (e) ->
    e.preventDefault()
    toRemove = $('.line-item-show-row').size()-5
    console.log('back all')
